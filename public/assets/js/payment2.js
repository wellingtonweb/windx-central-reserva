var cartCopy=[],billetsCart=function(){function t(t,e,a,i,s,o,n,r){this.billet_id=t.toString().trim(),this.reference=e,this.duedate=a,this.value=i,this.addition=s,this.discount=o,this.price=n,this.count=r}function e(){sessionStorage.setItem("billetsCart",JSON.stringify(cart)),$("#cartPayment").val(JSON.stringify(cart)),$("#cartBillets").val(JSON.stringify(cart))}cart=[],null!=sessionStorage.getItem("billetsCart")&&(cart=JSON.parse(sessionStorage.getItem("billetsCart")));var a={addItemToCart:function(a,i,s,o,n,r,l,c){var d=new t(a,i,s,o,n,r,l,c);cart.some((function(t){return t.billet_id===d.billet_id}))?notify("A fatura de nº "+d.reference+" já foi adicionada!"):(cart.push(d),e())},removeItemFromCart:function(t){for(var a in cart)if(cart[a].reference===t){cart[a].count--,0===cart[a].count&&cart.splice(a,1);break}e()},clearCart:function(){cart=[],e()},totalCount:function(){var t=0;for(var e in cart)t+=cart[e].count;return t},totalCart:function(){var t=0;for(var e in cart)t+=cart[e].price*cart[e].count;return Number(t.toFixed(2))}};return a}(),total=0,count=0;function clearAllSections(){billetsCart.clearCart(),sessionStorage.clear(),localStorage.clear(),removePaintAll(),displayCart()}function removePaintAll(){$(".invoice-slide").each((function(t){$(this).removeClass("border-success text-windx-50"),$(".delete-item").addClass("d-none not-active"),$(".add-to-cart").removeClass("not-active d-none"),$(".btn-copy").removeClass("not-active"),$(".btn-print-billet").removeClass("not-active"),$(".invoice-title").removeClass("text-windx-50")}))}function changeTootip(t){$("#"+t).attr("title","Copiado!").tooltip("fixTitle").tooltip("show").attr("title","Copy to Clipboard").tooltip("fixTitle")}async function copyBarcode(t){let e=$("#"+t).attr("data-code");await navigator.clipboard.writeText(e).then((()=>{notify("Copiado com sucesso!")})).catch((t=>{notify("Falha ao copiar: "+t)}))}function addPaintItem(t){const e=parseInt(t.replace(/[^0-9]/g,""));$("#invoice-"+e).addClass("border-success text-windx-50"),$("#title-"+e).addClass("text-windx-50"),$("#select-billet-"+e).addClass("d-none").addClass("not-active"),$("#remove-billet-"+e).removeClass("d-none not-active"),$("#copy-barcode-"+e).addClass("not-active"),$("#print-billet-"+e).addClass("not-active"),sessionStorage.setItem(e,"add")}function removePaintItem(t){const e=parseInt(t.replace(/[^0-9]/g,""));$("#invoice-"+e).removeClass("border-success text-windx-50"),$("#title-"+e).removeClass("text-windx-50"),$("#select-billet-"+e).removeClass("d-none").removeClass("not-active"),$("#remove-billet-"+e).addClass("d-none not-active"),$("#copy-barcode-"+e).removeClass("not-active"),$("#print-billet-"+e).removeClass("not-active"),sessionStorage.removeItem(e)}function paintBilletSession(){let t="",e="";null!=sessionStorage.getItem("billetsCart")&&(billetsSession=JSON.parse(sessionStorage.getItem("billetsCart")),$.each(billetsSession,(function(a,i){t=billetsSession[a].billet_id,$(".invoice-slide").each((function(a){e=$(this).attr("data-id"),e==t&&($(this).addClass("border-success text-windx-50"),$(".invoice-title").each((function(){$(this).attr("data-id")==e&&$(this).addClass("text-windx-50")})),$(".btn.btn-copy").each((function(){$(this).attr("data-id")==e&&$(this).addClass("not-active")})),$(".btn.btn-print-billet").each((function(){$(this).attr("data-id")==e&&$(this).addClass("not-active")})),$(".btn.add-to-cart").each((function(){$(this).attr("data-id")==e&&$(this).addClass("d-none")})),$(".btn.delete-item").each((function(){$(this).attr("data-id")==e&&$(this).removeClass("d-none")})))}))})))}function displayCart(){var t=billetsCart.totalCart(),e=billetsCart.totalCount();$(".total-cart").html(t.toFixed(2).replace(".",",")),$(".total-count").html(e),$(".display-text").html(e>1?" faturas via ":" fatura via "),0!=e?$(".checkout-controls button").each((function(){$(this).prop("disabled",!1)})):$(".checkout-controls button").each((function(){$(this).prop("disabled",!0)}))}$(".add-to-cart").click((function(t){t.preventDefault();var e=$(this).attr("id"),a=$(this).data("id"),i=$(this).data("reference"),s=$(this).data("duedate"),o=$(this).data("value"),n=$(this).data("addition"),r=$(this).data("discount"),l=Number($(this).data("price"));billetsCart.addItemToCart(a,i,s,o,n,r,l,1),addPaintItem(e),displayCart()})),$(".delete-item").on("click",(function(t){var e=$(this).attr("id"),a=$(this).data("reference");billetsCart.removeItemFromCart(a),removePaintItem(e),displayCart()})),$(".clear-cart").click((function(){clearAllSections(),notify("Todas as faturas foram removidas!"),location.reload()})),paintBilletSession(),displayCart();let tries=0,paymentType="";var callback="";let transactionId="";function getPaymentText(t){switch(t){case"credit":return"cartão de crédito";case"debit":return"cartão de débito";case"picpay":return"Picpay";default:return"PIX"}}function resetCardFields(){$("#cc-numero").val(""),$("#cc-nome").val(""),$("#expiration_month").val(""),$("#expiration_year").val(""),$("#cc-cvv").val("")}function callbackPrintCoupon(t){console.log(base_url+"coupon/"+t),window.location=base_url+"coupon/"+t,displayMessageStatusTransaction("Imprimindo cupom","info",3e4)}function callbackTransaction(t){console.log(base_url+"callback/"+t),$.ajax({url:base_url+"callback/"+t,type:"GET",dataType:"JSON",data:JSON.stringify({}),success:function(e){"approved"===e.status&&callbackPrintCoupon(t),msgStatusTransaction(e.status),console.log("Message: ",e)}})}function sendPayment(t){$(document).find("small.error-text").text(""),$.ajax({type:t.methodForm,url:t.actionForm,data:t.dataForm,beforeSend:function(){Swal.fire({title:"Pagamento via "+getPaymentText(t.paymentType),html:"picpay"==t.method||"pix"==t.method?"Gerando qrcode...":"Validando dados...",timer:6e4,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()},allowOutsideClick:()=>{const t=Swal.getPopup();return t.classList.remove("swal2-show"),setTimeout((()=>{t.classList.add("animate__animated","animate__headShake")})),setTimeout((()=>{t.classList.remove("animate__animated","animate__headShake")}),500),!1},willClose:()=>{}}).then((t=>{t.dismiss===Swal.DismissReason.timer&&displayMessageErrorPayment("Servidor indisponível")}))},success:function(e){if(console.log(e),0==e&&"error"==e.original.status&&void 0!==e.data)return console.log("Servidor indisponível"),clearInterval(callback),void displayMessageErrorPayment("Servidor indisponível");sessionStorage.setItem("transactionId",e.data.id),transactionId=sessionStorage.getItem("transactionId"),"picpay"==t.paymentType||"pix"==t.paymentType?setQrcode(e.data.qrCode,t.paymentType,e.data.copyPaste):422!=e.status?($("#modal-payment-form").modal("hide"),displayMessageWaitingPayment()):console.log("Verifique os campos em vermelho!"),callback=setInterval((function(){"undefined"==transactionId&&null==transactionId||callbackTransaction(transactionId)}),5e3)},error:function(t){console.log("Data error: ",t),$("#payment-form-dialog").removeClass("d-none"),t.responseJSON?(swal.close(),t.responseJSON.error?(console.log(t),notifySystem(t.status,t.responseJSON.status,t.responseJSON.error)):(console.log("Mais de um erro!"),$.each(t.responseJSON.errors,(function(t,e){$("input[name="+t+"]").is(":hidden")?(console.log(t,e[0]),displayMessageErrorPayment("Erro: 422 - Dados inválidos")):($("small."+t+"_error").text(e[0]),$("div.text-display-error").html("Verifique os dados informados!").removeClass("d-none"),$("input[name="+t+"]").addClass("is-invalid"))})))):(console.log(t),$("div.text-display-error").html(t.responseText).removeClass("d-none"))}})}function setQrcode(t,e,a){let i=$("#form_checkout span.total-count").text();displayCart(),Swal.fire({html:'<div id="modal-qrcode" class="text-center justify-content-center">Pagamento de <strong>'+i+"</strong> "+(i>1?"faturas":"fatura")+' via <strong class="text-capitalize">'+e+'</strong><br><br>Total à pagar: <b>R$ </b><span class="font-weight-bold">'+$(".total-cart").html()+'</span><div id="container-qrcode"><div class="body-popup-qrcode"><div class="qrcode-container"><img id="qrcode-img" class="w-75-" src="'+("pix"==e?"data:image\\/png;base64,":"")+t+'"></div></div><p>Leia o QRCode com seu app</p><p id="labelWaitingPayment" class="pt-3 text-black-50 animate__animated animate__fadeIn d-none">Aguardando confirmação de pagamento...</p><p id="timer" class="text-danger"></p></div>',timer:12e4,timerProgressBar:!1,showConfirmButton:!1,showDenyButton:!0,denyButtonText:'<i class="fas fa fa-times pr-1" aria-hidden="true"></i>CANCELAR',denyButtonColor:"#d33",didOpen:()=>{"pix"==e&&$("#btnPixCopyPaste").removeClass("d-none"),Swal.hideLoading(),countdown(),setTimeout((()=>{$("#labelWaitingPayment").removeClass("d-none")}),6e4)},willClose:()=>{clearInterval(undefined)},allowOutsideClick:()=>{const t=Swal.getPopup();return t.classList.remove("swal2-show"),setTimeout((()=>{t.classList.add("animate__animated","animate__headShake")})),setTimeout((()=>{t.classList.remove("animate__animated","animate__headShake")}),500),!1}}).then((t=>{t.dismiss===Swal.DismissReason.timer||t.isDismissed?msgStatusTransaction("expired"):t.isDenied&&(tries=5,clearAllSections(),msgStatusTransaction("canceled"),window.location.reload())}))}function msgStatusTransaction(t){if(t)switch(t){case"approved":return clearInterval(callback),console.log(sessionStorage.getItem("billetsCart")),displayMessageStatusTransaction("Pagamento realizado com sucesso!","success",5e3),!0;case"expired":return clearInterval(callback),displayMessageStatusTransaction("Tempo expirado!","error",5e3),!1;case"refused":return clearInterval(callback),displayMessageStatusTransaction("Pagamento recusado!","error",5e3),!1;case"canceled":return clearInterval(callback),displayMessageStatusTransaction("Pagamento cancelado!","error",5e3),!1;case"created":return console.log("Status: ",t),!1;default:return!1}else displayMessageStatusTransaction("Não houve nenhum pagamento criado!","error",5e3)}function displayMessageWaitingPayment(){Swal.fire({title:"Aguarde!",html:"Processando pagamento...",timer:12e4,timerProgressBar:!0,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()},willClose:()=>{clearInterval(timerInterval)},allowOutsideClick:()=>{const t=Swal.getPopup();return t.classList.remove("swal2-show"),setTimeout((()=>{t.classList.add("animate__animated","animate__headShake")})),setTimeout((()=>{t.classList.remove("animate__animated","animate__headShake")}),500),!1}})}function displayMessageErrorPayment(t){clearInterval(callback),Swal.fire({icon:"error",title:t,html:"<h4>Não foi possível concluir o pagamento!</h4>",timer:5e3,timerProgressBar:!1,confirmButtonText:"Ok",showDenyButton:!1,didOpen:()=>{Swal.hideLoading()},willClose:()=>{displayMessageQuestionFinish()}})}function displayMessageStatusTransaction(t,e,a){clearInterval(callback),Swal.fire({title:t,icon:e,timer:a,didOpen:()=>{Swal.hideLoading()},allowOutsideClick:()=>{const t=Swal.getPopup();return t.classList.remove("swal2-show"),setTimeout((()=>{t.classList.add("animate__animated","animate__headShake")})),setTimeout((()=>{t.classList.remove("animate__animated","animate__headShake")}),500),!1},willClose:()=>{clearAllSections(),displayMessageQuestionFinish()}})}function checkCartSession(){null==sessionStorage.getItem("billetsCart")&&(window.location.href=window.location.href)}clearAllSections(),$("#modal-payment-form").on("hidden.bs.modal",(function(t){resetCardFields()})),$("button.btn-payment-type").click((function(){switch(this.id){case"btn-picpay":case"btn-pix":$(".payment_type_label").text("btn-picpay"==this.id?"Picpay":"Pix"),$("#payment_type").val("btn-picpay"==this.id?"picpay":"pix"),$("#method").val("btn-picpay"==this.id?"picpay":"ecommerce"),resetCardFields(),$("#form_checkout").submit();break;default:$(".payment_type_label").text("btn-credit"==this.id?"Crédito":"Débito"),$("#payment_type").val("btn-credit"==this.id?"credit":"debit"),$("#method").val("tef"),$("#form_checkout").submit()}})),$("#form_checkout").submit((function(t){t.preventDefault();let e=$(this).serializeArray();""==e[1].value&&displayMessageErrorPayment("Erro: 422 - Dados inválidos");let a={paymentType:$("#payment_type").val(),actionForm:$(this).attr("action"),methodForm:$(this).attr("method"),dataForm:$(this).serialize(),methodCheckout:e[9].value};null!=a?(sessionStorage.setItem("payment",JSON.stringify(a)),sendPayment(a)):(clearAllSections(),displayMessageErrorPayment("Sessão de pagamento inválida!"))}));
